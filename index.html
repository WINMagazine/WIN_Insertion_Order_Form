<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WIN Magazine - Insertion Order</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Source+Sans+Pro:wght@300;400;600;700&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --win-red: #c41e3a;
            --win-red-dark: #9a1830;
            --win-black: #1a1a1a;
            --win-gray: #4a4a4a;
            --win-light: #f7f7f7;
            --win-border: #d0d0d0;
            --win-white: #ffffff;
            --win-green: #2d8a4e;
            --win-blue: #2563eb;
        }

        body {
            font-family: 'Source Sans Pro', sans-serif;
            background: var(--win-light);
            color: var(--win-black);
            line-height: 1.5;
        }

        /* ===== LOGIN SCREEN ===== */
        .login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--win-black);
            display: flex; align-items: center; justify-content: center;
            z-index: 9999;
        }
        .login-overlay.hidden { display: none; }
        .login-box {
            background: var(--win-white);
            padding: 50px 40px;
            border-radius: 8px;
            text-align: center;
            width: 380px;
            border-top: 5px solid var(--win-red);
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .login-box h2 {
            font-family: 'Oswald', sans-serif;
            font-size: 26px;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 8px;
        }
        .login-box p { color: var(--win-gray); margin-bottom: 25px; font-size: 14px; }
        .login-box input {
            width: 100%; padding: 14px 18px; border: 2px solid var(--win-border);
            border-radius: 6px; font-size: 16px; text-align: center;
            font-family: 'Source Sans Pro', sans-serif;
            letter-spacing: 3px;
        }
        .login-box input:focus { outline: none; border-color: var(--win-red); }
        .login-box button {
            width: 100%; padding: 14px; margin-top: 15px;
            background: var(--win-red); color: white; border: none;
            border-radius: 6px; font-size: 16px; font-weight: 600;
            font-family: 'Oswald', sans-serif; text-transform: uppercase;
            letter-spacing: 1px; cursor: pointer; transition: background 0.2s;
        }
        .login-box button:hover { background: var(--win-red-dark); }
        .login-error { color: var(--win-red); font-size: 13px; margin-top: 10px; display: none; }

        /* ===== MAIN CONTENT ===== */
        .main-content { display: none; }
        .main-content.visible { display: block; }

        .container { max-width: 960px; margin: 0 auto; padding: 20px; }

        header {
            background: var(--win-black); color: white;
            padding: 22px 30px; margin-bottom: 24px;
            border-bottom: 5px solid var(--win-red);
            display: flex; justify-content: space-between; align-items: center;
        }
        header h1 {
            font-family: 'Oswald', sans-serif; font-size: 24px;
            font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
        }
        header .subtitle { font-size: 13px; opacity: 0.7; margin-top: 3px; }
        header .right-info {
            text-align: right; font-size: 12px; opacity: 0.7;
        }

        /* ===== FORM SECTIONS ===== */
        .form-section {
            background: var(--win-white); border: 1px solid var(--win-border);
            border-radius: 8px; padding: 24px; margin-bottom: 20px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
        }
        .form-section h2 {
            font-family: 'Oswald', sans-serif; font-size: 18px;
            text-transform: uppercase; letter-spacing: 1px;
            color: var(--win-red); border-bottom: 2px solid var(--win-red);
            padding-bottom: 8px; margin-bottom: 18px;
        }
        .form-row {
            display: grid; grid-template-columns: 1fr 1fr; gap: 16px;
            margin-bottom: 14px;
        }
        .form-row.three { grid-template-columns: 1fr 1fr 1fr; }
        .form-group { margin-bottom: 14px; }
        .form-group label {
            display: block; font-size: 13px; font-weight: 600;
            color: var(--win-gray); margin-bottom: 4px; text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 10px 14px; border: 1px solid var(--win-border);
            border-radius: 5px; font-size: 15px; font-family: 'Source Sans Pro', sans-serif;
            transition: border-color 0.2s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; border-color: var(--win-red);
        }
        .form-group textarea { resize: vertical; min-height: 60px; }

        /* ===== PACKAGE SELECTOR ===== */
        .package-selector {
            display: grid; grid-template-columns: 1fr 1fr; gap: 16px;
            margin-bottom: 20px;
        }
        .package-selector .form-group { margin-bottom: 0; }

        /* ===== ISSUE GRID ===== */
        .issue-controls {
            display: flex; gap: 8px; margin-bottom: 14px; flex-wrap: wrap;
        }
        .issue-controls button {
            padding: 6px 14px; border: 1px solid var(--win-border);
            border-radius: 4px; background: var(--win-white); font-size: 13px;
            cursor: pointer; font-family: 'Source Sans Pro', sans-serif;
            transition: all 0.15s;
        }
        .issue-controls button:hover {
            background: var(--win-red); color: white; border-color: var(--win-red);
        }
        .issue-controls .active-btn {
            background: var(--win-red); color: white; border-color: var(--win-red);
        }

        .issues-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
        }
        .issue-card {
            border: 2px solid var(--win-border); border-radius: 6px;
            padding: 12px; text-align: center; cursor: pointer;
            transition: all 0.15s; position: relative; background: var(--win-white);
        }
        .issue-card:hover { border-color: var(--win-red); }
        .issue-card.selected {
            border-color: var(--win-red); background: #fef2f4;
        }
        .issue-card.next-issue::after {
            content: 'NEXT'; position: absolute; top: -8px; right: -8px;
            background: var(--win-green); color: white; font-size: 9px;
            padding: 2px 6px; border-radius: 3px; font-weight: 700;
            letter-spacing: 0.5px;
        }
        .issue-card .issue-num {
            font-family: 'Oswald', sans-serif; font-size: 20px;
            color: var(--win-red); font-weight: 700;
        }
        .issue-card .issue-name {
            font-size: 12px; color: var(--win-gray); font-weight: 600;
            text-transform: uppercase; margin-bottom: 6px;
        }
        .issue-card .issue-price {
            font-size: 14px; font-weight: 700; color: var(--win-black);
        }
        .issue-card .issue-preview-badge {
            font-size: 9px; background: var(--win-black); color: white;
            padding: 1px 6px; border-radius: 3px; display: inline-block;
            margin-bottom: 4px; letter-spacing: 0.5px;
        }
        .issue-card select {
            width: 100%; margin-top: 6px; padding: 4px;
            border: 1px solid var(--win-border); border-radius: 3px;
            font-size: 12px; font-family: 'Source Sans Pro', sans-serif;
            display: none;
        }
        .issue-card.selected select { display: block; }

        .customize-toggle {
            margin: 14px 0 0; display: flex; align-items: center; gap: 8px;
        }
        .customize-toggle input[type="checkbox"] {
            width: 16px; height: 16px; accent-color: var(--win-red);
        }
        .customize-toggle label {
            font-size: 13px; font-weight: 600; color: var(--win-gray);
            cursor: pointer;
        }

        /* ===== EMAIL/DIGITAL SECTION ===== */
        .digital-options {
            display: grid; grid-template-columns: 1fr 1fr; gap: 16px;
        }
        .digital-card {
            border: 2px solid var(--win-border); border-radius: 6px;
            padding: 16px; transition: all 0.15s;
        }
        .digital-card.selected { border-color: var(--win-blue); background: #f0f5ff; }
        .digital-card .card-header {
            display: flex; align-items: center; gap: 8px; margin-bottom: 8px;
        }
        .digital-card .card-header input[type="checkbox"] {
            width: 16px; height: 16px; accent-color: var(--win-blue);
        }
        .digital-card .card-title {
            font-weight: 700; font-size: 14px;
        }
        .digital-card .card-price {
            font-size: 13px; color: var(--win-gray);
        }
        .digital-card .card-detail {
            font-size: 12px; color: var(--win-gray); margin-top: 6px;
        }
        .email-qty-row {
            display: flex; align-items: center; gap: 10px; margin-top: 10px;
        }
        .email-qty-row label { font-size: 13px; font-weight: 600; }
        .email-qty-row input {
            width: 60px; padding: 6px; border: 1px solid var(--win-border);
            border-radius: 4px; text-align: center; font-size: 14px;
        }
        .email-qty-row .qty-total {
            font-weight: 700; font-size: 14px;
        }

        /* ===== DISCOUNTS ===== */
        .discount-row {
            display: flex; gap: 10px; align-items: center; margin-bottom: 8px;
        }
        .discount-row input[type="text"] {
            flex: 1; padding: 8px 12px; border: 1px solid var(--win-border);
            border-radius: 4px; font-size: 14px; font-family: 'Source Sans Pro', sans-serif;
        }
        .discount-row input[type="number"] {
            width: 110px; padding: 8px 12px; border: 1px solid var(--win-border);
            border-radius: 4px; font-size: 14px; font-family: 'Source Sans Pro', sans-serif;
        }
        .discount-row .remove-btn {
            background: none; border: none; color: var(--win-red);
            font-size: 20px; cursor: pointer; padding: 0 6px; line-height: 1;
        }
        .add-btn {
            padding: 8px 16px; border: 1px dashed var(--win-border);
            border-radius: 4px; background: none; font-size: 13px;
            cursor: pointer; color: var(--win-gray); transition: all 0.15s;
            font-family: 'Source Sans Pro', sans-serif;
        }
        .add-btn:hover { border-color: var(--win-red); color: var(--win-red); }

        .prepay-check {
            display: flex; align-items: center; gap: 10px;
            padding: 12px; border: 1px solid var(--win-border); border-radius: 6px;
            margin-bottom: 14px; background: #fefce8;
        }
        .prepay-check input { width: 18px; height: 18px; accent-color: var(--win-green); }
        .prepay-check label { font-size: 14px; font-weight: 600; cursor: pointer; }
        .prepay-check .savings { color: var(--win-green); font-weight: 700; margin-left: 6px; }

        /* ===== ADDITIONAL OPTIONS ===== */
        .options-row {
            display: flex; gap: 20px; flex-wrap: wrap;
        }
        .option-item {
            display: flex; align-items: center; gap: 8px;
        }
        .option-item input { width: 16px; height: 16px; accent-color: var(--win-red); }
        .option-item label { font-size: 14px; cursor: pointer; }

        /* ===== TOTALS ===== */
        .totals-section {
            background: var(--win-black); color: white;
            border-radius: 8px; padding: 24px; margin-bottom: 20px;
        }
        .totals-section h2 {
            font-family: 'Oswald', sans-serif; font-size: 18px;
            text-transform: uppercase; letter-spacing: 1px;
            border-bottom: 2px solid var(--win-red); padding-bottom: 8px;
            margin-bottom: 14px; color: white;
        }
        .total-line {
            display: flex; justify-content: space-between; align-items: center;
            padding: 6px 0; font-size: 15px;
        }
        .total-line.subtotal { border-top: 1px solid #444; padding-top: 12px; margin-top: 6px; }
        .total-line.discount { color: var(--win-green); }
        .total-line.grand-total {
            border-top: 2px solid var(--win-red); padding-top: 14px; margin-top: 10px;
            font-size: 22px; font-weight: 700;
            font-family: 'Oswald', sans-serif;
        }
        .total-line .label { opacity: 0.85; }
        .total-line.grand-total .label { opacity: 1; }
        .tier-badge {
            display: inline-block; background: var(--win-red);
            padding: 2px 10px; border-radius: 3px; font-size: 11px;
            font-weight: 700; letter-spacing: 0.5px; margin-left: 8px;
            text-transform: uppercase;
        }

        /* ===== PAYMENT & SIGNATURES ===== */
        .payment-terms {
            background: #fef3cd; border: 1px solid #ffc107;
            border-radius: 6px; padding: 14px; margin-bottom: 16px;
            font-size: 14px;
        }
        .payment-terms strong { color: var(--win-black); }
        .sig-row {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
            margin-top: 16px;
        }
        .sig-block { padding: 16px; border: 1px solid var(--win-border); border-radius: 6px; }
        .sig-block .sig-label {
            font-size: 12px; font-weight: 600; color: var(--win-gray);
            text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px;
        }
        .sig-line {
            border-bottom: 1px solid var(--win-black); height: 30px;
            margin-bottom: 4px;
        }
        .sig-caption { font-size: 11px; color: var(--win-gray); }

        /* ===== SUBMIT ===== */
        .submit-section { text-align: center; margin: 24px 0; }
        .submit-section button {
            padding: 16px 50px; font-size: 18px; font-weight: 700;
            font-family: 'Oswald', sans-serif; text-transform: uppercase;
            letter-spacing: 2px; border: none; border-radius: 6px;
            cursor: pointer; transition: all 0.2s; margin: 0 8px;
        }
        .btn-submit {
            background: var(--win-red); color: white;
        }
        .btn-submit:hover { background: var(--win-red-dark); }
        .btn-reset {
            background: var(--win-border); color: var(--win-black);
        }
        .btn-reset:hover { background: #bbb; }

        .status-message {
            margin-top: 14px; padding: 12px; border-radius: 6px; font-size: 14px;
            display: none;
        }
        .status-message.success { display: block; background: #d4edda; color: #155724; }
        .status-message.error { display: block; background: #f8d7da; color: #721c24; }
        .status-message.info { display: block; background: #d1ecf1; color: #0c5460; }

        /* ===== VOLUME CHECKLIST ===== */
        .volume-checklist {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;
            margin-bottom: 18px;
        }
        .volume-check-item {
            display: flex; align-items: center; gap: 8px;
            padding: 8px 12px; border: 1px solid var(--win-border);
            border-radius: 5px; background: var(--win-white);
            cursor: pointer; transition: all 0.15s; user-select: none;
        }
        .volume-check-item:hover { border-color: var(--win-red); }
        .volume-check-item.checked {
            border-color: var(--win-red); background: #fef2f4;
        }
        .volume-check-item input[type="checkbox"] {
            width: 16px; height: 16px; accent-color: var(--win-red);
            cursor: pointer;
        }
        .volume-check-item .vol-check-label {
            font-size: 13px; font-weight: 600; color: var(--win-black);
            cursor: pointer;
        }
        .volume-check-item .vol-badge {
            background: var(--win-red); color: white; font-size: 10px;
            font-weight: 700; padding: 1px 6px; border-radius: 10px;
            min-width: 18px; text-align: center; display: none;
            margin-left: auto;
        }
        .volume-check-item .vol-badge.has-count { display: inline-block; }

        /* ===== VOLUME ISSUE SECTIONS ===== */
        .volume-section {
            border: 1px solid var(--win-border); border-radius: 6px;
            margin-bottom: 10px; overflow: hidden;
            display: none;
        }
        .volume-section.visible { display: block; }
        .volume-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 16px; background: var(--win-light);
            border-bottom: 1px solid var(--win-border); user-select: none;
        }
        .volume-header .vol-title {
            font-family: 'Oswald', sans-serif; font-size: 15px;
            font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .volume-header .vol-badge {
            background: var(--win-red); color: white; font-size: 11px;
            font-weight: 700; padding: 2px 8px; border-radius: 10px;
            min-width: 22px; text-align: center; display: none;
        }
        .volume-header .vol-badge.has-count { display: inline-block; }
        .volume-body {
            padding: 12px 16px;
        }
        .volume-controls {
            display: flex; gap: 6px; margin-bottom: 10px; flex-wrap: wrap;
        }
        .volume-controls button {
            padding: 4px 10px; border: 1px solid var(--win-border);
            border-radius: 3px; background: var(--win-white); font-size: 12px;
            cursor: pointer; font-family: 'Source Sans Pro', sans-serif;
            transition: all 0.15s;
        }
        .volume-controls button:hover {
            background: var(--win-red); color: white; border-color: var(--win-red);
        }

        /* ===== PDF PREVIEW MODAL ===== */
        .pdf-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 10000;
            display: none; align-items: center; justify-content: center;
            flex-direction: column;
        }
        .pdf-modal-overlay.visible { display: flex; }
        .pdf-modal-frame {
            width: 90%; max-width: 800px; height: 75vh;
            background: white; border-radius: 8px; overflow: hidden;
        }
        .pdf-modal-frame iframe {
            width: 100%; height: 100%; border: none;
        }
        .pdf-modal-actions {
            display: flex; gap: 16px; margin-top: 16px;
        }
        .pdf-modal-actions button {
            padding: 14px 36px; font-size: 16px; font-weight: 700;
            font-family: 'Oswald', sans-serif; text-transform: uppercase;
            letter-spacing: 1px; border: none; border-radius: 6px;
            cursor: pointer; transition: all 0.2s;
        }
        .pdf-modal-actions .btn-back {
            background: var(--win-border); color: var(--win-black);
        }
        .pdf-modal-actions .btn-back:hover { background: #bbb; }
        .pdf-modal-actions .btn-send {
            background: var(--win-green); color: white;
        }
        .pdf-modal-actions .btn-send:hover { background: #236b3e; }

        /* ===== TIER COMPARISON PANEL ===== */
        .tier-panel {
            background: var(--win-white); border: 1px solid var(--win-border);
            border-radius: 8px; margin-bottom: 20px; overflow: hidden;
        }
        .tier-panel-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 18px; cursor: pointer; background: var(--win-light);
            border-bottom: 1px solid var(--win-border); user-select: none;
        }
        .tier-panel-header:hover { background: #eee; }
        .tier-panel-header h2 {
            font-family: 'Oswald', sans-serif; font-size: 16px;
            text-transform: uppercase; letter-spacing: 1px;
            color: var(--win-red); margin: 0; border: none; padding: 0;
        }
        .tier-panel-body { display: none; padding: 16px 18px; }
        .tier-panel.expanded .tier-panel-body { display: block; }
        .tier-table {
            width: 100%; border-collapse: collapse; font-size: 13px;
        }
        .tier-table th {
            text-align: left; padding: 6px 10px; background: var(--win-light);
            font-weight: 700; font-size: 12px; text-transform: uppercase;
            letter-spacing: 0.5px; color: var(--win-gray);
            border-bottom: 2px solid var(--win-border);
        }
        .tier-table td {
            padding: 8px 10px; border-bottom: 1px solid var(--win-border);
        }
        .tier-table tr.active-tier {
            background: #fef2f4; border-left: 3px solid var(--win-red);
        }
        .tier-table tr.active-tier td:first-child { font-weight: 700; color: var(--win-red); }

        /* ===== DRAFT RESTORE MODAL ===== */
        .draft-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 10001;
            display: none; align-items: center; justify-content: center;
        }
        .draft-modal-overlay.visible { display: flex; }
        .draft-modal {
            background: white; padding: 30px 36px; border-radius: 8px;
            text-align: center; max-width: 420px; width: 90%;
            border-top: 5px solid var(--win-red);
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .draft-modal h3 {
            font-family: 'Oswald', sans-serif; font-size: 20px;
            text-transform: uppercase; margin-bottom: 10px;
        }
        .draft-modal p { color: var(--win-gray); margin-bottom: 20px; font-size: 14px; }
        .draft-modal-btns { display: flex; gap: 12px; justify-content: center; }
        .draft-modal-btns button {
            padding: 10px 28px; font-size: 14px; font-weight: 700;
            font-family: 'Oswald', sans-serif; text-transform: uppercase;
            border: none; border-radius: 6px; cursor: pointer;
        }
        .draft-modal-btns .btn-yes { background: var(--win-red); color: white; }
        .draft-modal-btns .btn-no { background: var(--win-border); color: var(--win-black); }

        /* ===== EMAIL SEASON INPUTS ===== */
        .email-season-row {
            display: flex; gap: 14px; align-items: center; margin-top: 10px; flex-wrap: wrap;
        }
        .email-season-group {
            display: flex; align-items: center; gap: 6px;
        }
        .email-season-group label { font-size: 12px; font-weight: 600; white-space: nowrap; }
        .email-season-group input {
            width: 55px; padding: 5px; border: 1px solid var(--win-border);
            border-radius: 4px; text-align: center; font-size: 13px;
        }
        .email-block-note {
            font-size: 12px; color: var(--win-green); font-weight: 700;
            margin-top: 6px; display: none;
        }
        .email-block-note.visible { display: block; }

        /* Responsive */
        @media (max-width: 768px) {
            .form-row, .package-selector, .digital-options, .sig-row { grid-template-columns: 1fr; }
            .issues-grid { grid-template-columns: repeat(3, 1fr); }
            .volume-checklist { grid-template-columns: repeat(2, 1fr); }
            header { flex-direction: column; text-align: center; }
            header .right-info { text-align: center; margin-top: 8px; }
        }
        @media (max-width: 480px) {
            .issues-grid { grid-template-columns: repeat(2, 1fr); }
            .volume-checklist { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- LOGIN -->
    <div class="login-overlay" id="login-overlay">
        <div class="login-box">
            <h2>WIN Magazine</h2>
            <p>Insertion Order System</p>
            <input type="password" id="login-password" placeholder="Enter PIN"
                   onkeydown="if(event.key==='Enter')checkPassword()">
            <button onclick="checkPassword()">Access Form</button>
            <div class="login-error" id="login-error">Incorrect PIN. Try again.</div>
        </div>
    </div>

    <!-- MAIN FORM -->
    <div class="main-content" id="main-content">
    <div class="container">
        <header>
            <div>
                <h1>WIN Magazine Insertion Order</h1>
                <div class="subtitle">Volumes 32–42 | 3-Year Fixed-Price Renewal Option</div>
            </div>
            <div class="right-info">
                WIN Magazine<br>
                PO Box 194 / Newton, IA 50208<br>
                P: 641-792-4436
            </div>
        </header>

        <form id="io-form" onsubmit="return false;">

            <!-- ADVERTISER INFO -->
            <div class="form-section">
                <h2>Advertiser Information</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="advertiser-name">Advertiser Name</label>
                        <input type="text" id="advertiser-name" required>
                    </div>
                    <div class="form-group">
                        <label for="acct-number">Account Number</label>
                        <input type="text" id="acct-number">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="contact-name">Contact (Print Name)</label>
                        <input type="text" id="contact-name" required>
                    </div>
                    <div class="form-group">
                        <label for="contact-email">Email</label>
                        <input type="email" id="contact-email">
                    </div>
                </div>
                <div class="form-group" id="billing-group" style="display:none;">
                    <label for="billing-address">Billing Address (if new)</label>
                    <textarea id="billing-address" rows="2"></textarea>
                </div>
                <div class="option-item">
                    <input type="checkbox" id="new-customer" onchange="document.getElementById('billing-group').style.display=this.checked?'block':'none'">
                    <label for="new-customer">New customer — show billing address</label>
                </div>
            </div>

            <!-- PACKAGE SELECTION -->
            <div class="form-section">
                <h2>Package Selection</h2>
                <div class="package-selector">
                    <div class="form-group">
                        <label for="package-type">Package Type</label>
                        <select id="package-type" onchange="onPackageChange()">
                            <option value="custom">Custom / À la Carte</option>
                            <option value="5issue">5-Issue Print Package (20% Off)</option>
                            <option value="annual">12-Issue Annual Print (23% Off)</option>
                            <option value="combo3">3-Month Combo — 3 Issues + 2 Emails (9-33% Off)</option>
                            <option value="combo6">6-Month Combo — 6 Issues + 3 Emails (7-13% Off)</option>
                            <option value="comboA">Annual Combo — 12 Issues + 4 Emails (17-21% Off)</option>
                            <option value="emailOnly">Email / Banner Only</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="default-size">Default Ad Size</label>
                        <select id="default-size" onchange="onDefaultSizeChange()">
                            <option value="full">Full Page</option>
                            <option value="half">1/2 Page</option>
                            <option value="third">1/3 Page</option>
                            <option value="quarter">1/4 Page</option>
                            <option value="eighth">1/8 Page</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="start-volume">Start Volume</label>
                        <select id="start-volume" onchange="buildStartIssueDropdown();onPackageChange()"></select>
                    </div>
                    <div class="form-group">
                        <label for="start-issue">Start Issue</label>
                        <select id="start-issue" onchange="onPackageChange()"></select>
                    </div>
                </div>
            </div>

            <!-- ISSUES (Volume Accordion) -->
            <div class="form-section">
                <h2>Issue Selection</h2>
                <div id="volume-checklist"></div>
                <div id="volume-issues-container"></div>
                <div class="customize-toggle">
                    <input type="checkbox" id="customize-sizes" onchange="toggleCustomize()">
                    <label for="customize-sizes">Customize ad sizes per issue</label>
                </div>
            </div>

            <!-- EMAIL / DIGITAL ADS -->
            <div class="form-section" id="digital-section">
                <h2>Email & Digital Advertising</h2>
                <div class="digital-options">
                    <div class="digital-card" id="banner-card">
                        <div class="card-header">
                            <input type="checkbox" id="web-banner" onchange="toggleDigitalCard('banner-card', this.checked); recalculate();">
                            <div>
                                <div class="card-title">Website Banner Ad</div>
                                <div class="card-price">$<input type="number" id="banner-price-input" value="2600" min="0" step="100" style="width:70px;padding:2px 6px;border:1px solid var(--win-border);border-radius:3px;font-size:13px;font-family:'Source Sans Pro',sans-serif;" onchange="STATE.bannerPrice=parseInt(this.value)||2600;recalculate()" oninput="STATE.bannerPrice=parseInt(this.value)||2600;recalculate()">/year</div>
                            </div>
                        </div>
                        <div class="card-detail">Full year banner on WIN-magazine.com</div>
                    </div>
                    <div class="digital-card" id="email-card">
                        <div class="card-header">
                            <input type="checkbox" id="email-ads" onchange="toggleDigitalCard('email-card', this.checked); recalculate();">
                            <div>
                                <div class="card-title">Weekly Email Newsletter Ads</div>
                                <div class="card-price">$500/wk In-Season (Sep–Apr) · $400/wk Off-Season (May–Aug)</div>
                            </div>
                        </div>
                        <div class="email-season-row" style="display:none" id="email-qty-row">
                            <div class="email-season-group">
                                <label>In-Season (Sep–Apr):</label>
                                <input type="number" id="email-in-season" min="0" value="0" onchange="recalculate()" oninput="recalculate()">
                                <span style="font-size:12px;color:var(--win-gray);">wks × $500</span>
                            </div>
                            <div class="email-season-group">
                                <label>Off-Season (May–Aug):</label>
                                <input type="number" id="email-off-season" min="0" value="0" onchange="recalculate()" oninput="recalculate()">
                                <span style="font-size:12px;color:var(--win-gray);">wks × $400</span>
                            </div>
                            <span>= <span class="qty-total" id="email-total">$0</span></span>
                        </div>
                        <div class="email-block-note" id="email-block-note">4-week block rate: $1,800 applied!</div>
                        <div class="card-detail">4 total weeks = $1,800 block rate</div>
                    </div>
                </div>
                <div class="form-row" style="margin-top: 14px;">
                    <div class="form-group">
                        <label for="banner-start-date">Banner Start Date</label>
                        <input type="date" id="banner-start-date">
                    </div>
                    <div class="form-group">
                        <label for="banner-end-date">Banner End Date</label>
                        <input type="date" id="banner-end-date">
                    </div>
                </div>
            </div>

            <!-- ADDITIONAL OPTIONS -->
            <div class="form-section">
                <h2>Additional Options</h2>
                <div class="options-row">
                    <div class="option-item">
                        <input type="checkbox" id="opt-design">
                        <label for="opt-design">Ad or Web Design Needed</label>
                    </div>
                    <div class="option-item">
                        <input type="checkbox" id="opt-ncaa">
                        <label for="opt-ncaa">NCAA/Big 12 Program Ad</label>
                    </div>
                </div>
            </div>

            <!-- DISCOUNTS & NOTES -->
            <div class="form-section">
                <h2>Discounts & Notes</h2>
                <div class="prepay-check">
                    <input type="checkbox" id="prepay-discount" onchange="recalculate()">
                    <label for="prepay-discount">Apply 7% Prepayment Discount (paid by Oct 1)</label>
                    <span class="savings" id="prepay-savings"></span>
                </div>
                <div id="discounts-container"></div>
                <button type="button" class="add-btn" onclick="addDiscount()">+ Add Custom Discount</button>
                <div class="form-group" style="margin-top: 18px;">
                    <label for="notes">Premium Placement / Misc. Notes</label>
                    <textarea id="notes" rows="3" placeholder="Notes or special terms..."></textarea>
                </div>
            </div>

            <!-- TIER COMPARISON -->
            <div class="tier-panel" id="tier-panel">
                <div class="tier-panel-header" onclick="document.getElementById('tier-panel').classList.toggle('expanded')">
                    <h2>Package Rate Comparison</h2>
                    <span class="vol-arrow">▼</span>
                </div>
                <div class="tier-panel-body" id="tier-panel-body"></div>
            </div>

            <!-- TOTALS -->
            <div class="totals-section" id="totals-section">
                <h2>Order Summary</h2>
                <div id="totals-lines"></div>
            </div>

            <!-- PAYMENT & SIGNATURES -->
            <div class="form-section">
                <h2>Payment & Signatures</h2>
                <div class="payment-terms">
                    <strong>Payment Terms:</strong> NET 30. Finance charge of 1.5%/month will be applied to balances past 30 days.<br>
                    <strong>3-Year Fixed-Price:</strong> This insertion order locks in Volume 32 pricing for up to 3 years.
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="signed-by">WIN Representative</label>
                        <input type="text" id="signed-by" value="Bryan">
                    </div>
                    <div class="form-group">
                        <label for="sign-date">Date</label>
                        <input type="date" id="sign-date">
                    </div>
                </div>
                <div class="sig-row">
                    <div class="sig-block">
                        <div class="sig-label">WIN Magazine Representative</div>
                        <div class="sig-line"></div>
                        <div class="sig-caption">Signature</div>
                    </div>
                    <div class="sig-block">
                        <div class="sig-label">Company / Advertiser Representative</div>
                        <div class="sig-line"></div>
                        <div class="sig-caption">Signature</div>
                        <div class="sig-line" style="margin-top:10px;"></div>
                        <div class="sig-caption">Date</div>
                    </div>
                </div>
            </div>

            <!-- SUBMIT -->
            <div class="submit-section">
                <button type="button" class="submit-section btn-reset" onclick="resetForm()">Reset</button>
                <button type="button" class="submit-section btn-submit" id="submit-btn" onclick="submitForm()">Generate PDF</button>
                <div class="status-message" id="status-msg"></div>
            </div>

        </form>
    </div>
    </div>

    <!-- PDF PREVIEW MODAL -->
    <div class="pdf-modal-overlay" id="pdf-modal">
        <div class="pdf-modal-frame">
            <iframe id="pdf-iframe"></iframe>
        </div>
        <div class="pdf-modal-actions">
            <button class="btn-back" onclick="closePdfModal()">Go Back & Edit</button>
            <button class="btn-send" id="btn-send-gina" onclick="sendToGina()">Send to Gina</button>
        </div>
    </div>

    <!-- DRAFT RESTORE MODAL -->
    <div class="draft-modal-overlay" id="draft-modal">
        <div class="draft-modal">
            <h3>Continue Draft?</h3>
            <p id="draft-modal-text">You have an unsaved draft. Continue editing?</p>
            <div class="draft-modal-btns">
                <button class="btn-yes" onclick="restoreDraft()">Yes, Continue</button>
                <button class="btn-no" onclick="clearDraftAndInit()">No, Start Fresh</button>
            </div>
        </div>
    </div>

<script>
// ============================================================
//  CONFIG
// ============================================================
// n8n webhook — replace with your production webhook URL after creating the workflow
// Expected format: https://peyton.app.n8n.cloud/webhook/win-insertion-order
var WEBHOOK_URL = 'https://peyton.app.n8n.cloud/webhook/win-insertion-order';
var DRAFT_KEY = 'win_io_draft_v2';

// ============================================================
//  PRICING DATA
// ============================================================
var ISSUE_TEMPLATE = [
    { id: 'oct-a', name: 'Oct (A)', num: 1, isPreview: true,  month: 10, label: 'Preview' },
    { id: 'oct-b', name: 'Oct (B)', num: 2, isPreview: false, month: 10, label: '' },
    { id: 'nov',   name: 'Nov',     num: 3, isPreview: false, month: 11, label: '' },
    { id: 'dec',   name: 'Dec',     num: 4, isPreview: false, month: 12, label: '' },
    { id: 'jan',   name: 'Jan',     num: 5, isPreview: false, month: 1,  label: '' },
    { id: 'mar',   name: 'Mar',     num: 6, isPreview: false, month: 3,  label: '' },
    { id: 'apr-a', name: 'Apr (A)', num: 7, isPreview: false, month: 4,  label: '' },
    { id: 'apr-b', name: 'Apr (B)', num: 8, isPreview: false, month: 4,  label: '' },
    { id: 'may',   name: 'May',     num: 9, isPreview: false, month: 5,  label: '' },
    { id: 'july',  name: 'July',    num: 10, isPreview: false, month: 7,  label: '' },
    { id: 'aug',   name: 'Aug',     num: 11, isPreview: false, month: 8,  label: '' },
    { id: 'sept',  name: 'Sept',    num: 12, isPreview: false, month: 9,  label: '' }
];

var VOLUMES = [];
for (var v = 32; v <= 42; v++) {
    var startYear = 2025 + (v - 32);
    VOLUMES.push({ num: v, label: 'Volume ' + v + ' (' + startYear + '\u2013' + (startYear + 1) + ')' });
}

var SIZES = ['full','half','third','quarter','eighth'];
var SIZE_LABELS = { full: 'Full Page', half: '1/2 Page', third: '1/3 Page', quarter: '1/4 Page', eighth: '1/8 Page' };

var SINGLE_RATE = { full: 1224, half: 675, third: 505, quarter: 369, eighth: 227 };
var PREVIEW_RATE = { full: 2595, half: 1428, third: 963, quarter: 737, eighth: 442 };
var FIVE_RATE = { full: 979, half: 540, third: 404, quarter: 295, eighth: 182 };
var ANNUAL_RATE = { full: 1032, half: 569, third: 417, quarter: 307, eighth: 188 };
var COMBO_ANNUAL = { full: 1187, half: 723, third: 572, quarter: 461, eighth: 342 };
var COMBO_6MO = { full: 1278, half: 820, third: 678, quarter: 564, eighth: 446 };
var COMBO_3MO = { full: 1410, half: 917, third: 763, quarter: 641, eighth: 376 };

// ============================================================
//  GLOBAL STATE
// ============================================================
var STATE = {
    selectedIssues: {},
    customizeSizes: false,
    expandedVolumes: { 32: true },
    bannerPrice: 2600,
    emailInSeason: 0,
    emailOffSeason: 0
};

// ============================================================
//  INIT
// ============================================================
function init() {
    buildStartVolumeDropdown();
    buildVolumeSelector();
    detectNextIssue();
    setTodayDate();
    recalculate();
    attachAutoSave();
}

function setTodayDate() {
    var today = new Date().toISOString().split('T')[0];
    document.getElementById('sign-date').value = today;
}

function buildStartVolumeDropdown() {
    var sel = document.getElementById('start-volume');
    sel.innerHTML = '';
    VOLUMES.forEach(function(v) {
        var opt = document.createElement('option');
        opt.value = v.num;
        opt.textContent = v.label;
        sel.appendChild(opt);
    });
    sel.value = 32;
    buildStartIssueDropdown();
}

function buildStartIssueDropdown() {
    var volNum = parseInt(document.getElementById('start-volume').value) || 32;
    var sel = document.getElementById('start-issue');
    var prevVal = sel.value;
    sel.innerHTML = '';
    ISSUE_TEMPLATE.forEach(function(issue, idx) {
        var code = volNum + String(issue.num).padStart(2, '0');
        var opt = document.createElement('option');
        opt.value = idx;
        opt.textContent = code + ' — ' + issue.name + (issue.isPreview ? ' (Preview)' : '');
        sel.appendChild(opt);
    });
    if (prevVal !== '' && prevVal >= 0 && prevVal < 12) sel.value = prevVal;
}

function detectNextIssue() {
    var now = new Date();
    var currentMonth = now.getMonth() + 1;
    var monthToIssue = { 1:5, 2:5, 3:6, 4:8, 5:9, 6:9, 7:10, 8:11, 9:0, 10:2, 11:3, 12:4 };
    var nextIdx = monthToIssue[currentMonth] || 0;
    document.getElementById('start-issue').value = nextIdx;
    setTimeout(function() {
        var card = document.getElementById('card-v32-' + nextIdx);
        if (card) card.classList.add('next-issue');
    }, 50);
}

function buildVolumeSelector() {
    var checklist = document.getElementById('volume-checklist');
    var issuesContainer = document.getElementById('volume-issues-container');
    var defaultSize = document.getElementById('default-size').value;
    checklist.innerHTML = '';
    issuesContainer.innerHTML = '';

    // Build checklist grid
    checklist.className = 'volume-checklist';
    VOLUMES.forEach(function(vol) {
        var isChecked = !!STATE.expandedVolumes[vol.num];
        var count = getVolumeSelectionCount(vol.num);
        var item = document.createElement('label');
        item.className = 'volume-check-item' + (isChecked ? ' checked' : '');
        item.id = 'vol-check-item-' + vol.num;
        var badgeClass = count > 0 ? 'vol-badge has-count' : 'vol-badge';
        item.innerHTML =
            '<input type="checkbox" id="vol-check-' + vol.num + '" ' + (isChecked ? 'checked' : '') +
            ' onchange="toggleVolumeCheck(' + vol.num + ')">' +
            '<span class="vol-check-label">' + vol.label + '</span>' +
            '<span class="' + badgeClass + '" id="vol-badge-' + vol.num + '">' + count + '</span>';
        checklist.appendChild(item);
    });

    // Build issue sections (hidden by default, shown when checkbox is checked)
    VOLUMES.forEach(function(vol) {
        var isChecked = !!STATE.expandedVolumes[vol.num];
        var section = document.createElement('div');
        section.className = 'volume-section' + (isChecked ? ' visible' : '');
        section.id = 'vol-section-' + vol.num;
        var count = getVolumeSelectionCount(vol.num);
        var badgeClass = count > 0 ? 'vol-badge has-count' : 'vol-badge';
        section.innerHTML =
            '<div class="volume-header">' +
                '<span class="vol-title">' + vol.label + '</span>' +
                '<span class="' + badgeClass + '" id="vol-section-badge-' + vol.num + '">' + count + '</span>' +
            '</div>' +
            '<div class="volume-body">' +
                '<div class="volume-controls">' +
                    '<button type="button" onclick="selectAllVolume(' + vol.num + ')">Select All</button>' +
                    '<button type="button" onclick="selectEveryOtherVolume(' + vol.num + ')">Every Other</button>' +
                    '<button type="button" onclick="clearVolume(' + vol.num + ')">Clear All</button>' +
                '</div>' +
                '<div class="issues-grid" id="issues-grid-' + vol.num + '"></div>' +
            '</div>';
        issuesContainer.appendChild(section);
        var grid = document.getElementById('issues-grid-' + vol.num);
        ISSUE_TEMPLATE.forEach(function(issue, idx) {
            var compositeId = 'v' + vol.num + '-' + idx;
            var card = document.createElement('div');
            card.className = 'issue-card';
            card.id = 'card-' + compositeId;
            card.setAttribute('data-vol', vol.num);
            card.setAttribute('data-idx', idx);
            card.onclick = function(e) { if (e.target.tagName === 'SELECT') return; toggleIssue(vol.num, idx); };
            var previewBadge = issue.isPreview ? '<div class="issue-preview-badge">PREVIEW</div>' : '';
            var sizeOptions = SIZES.map(function(s) {
                var sel = s === defaultSize ? ' selected' : '';
                return '<option value="' + s + '"' + sel + '>' + SIZE_LABELS[s] + '</option>';
            }).join('');
            var issueCode = vol.num + String(issue.num).padStart(2, '0');
            card.innerHTML = previewBadge +
                '<div class="issue-num">' + issueCode + '</div>' +
                '<div class="issue-name">' + issue.name + '</div>' +
                '<div class="issue-price" id="price-' + compositeId + '">\u2014</div>' +
                '<select id="size-' + compositeId + '" onchange="onIssueSizeChange(\'' + compositeId + '\');recalculate()">' + sizeOptions + '</select>';
            grid.appendChild(card);
        });
    });
}

// ============================================================
//  VOLUME & ISSUE SELECTION
// ============================================================
function toggleVolumeCheck(volNum) {
    var checkbox = document.getElementById('vol-check-' + volNum);
    var section = document.getElementById('vol-section-' + volNum);
    var checkItem = document.getElementById('vol-check-item-' + volNum);
    var isChecked = checkbox.checked;
    if (isChecked) {
        section.classList.add('visible');
        checkItem.classList.add('checked');
        STATE.expandedVolumes[volNum] = true;
    } else {
        section.classList.remove('visible');
        checkItem.classList.remove('checked');
        STATE.expandedVolumes[volNum] = false;
        // Remove all selected issues for this volume
        ISSUE_TEMPLATE.forEach(function(issue, idx) {
            delete STATE.selectedIssues['v' + volNum + '-' + idx];
        });
        syncStateToDOM();
        recalculate();
        saveDraft();
    }
}

function getVolumeSelectionCount(volNum) {
    var count = 0;
    Object.keys(STATE.selectedIssues).forEach(function(key) {
        if (STATE.selectedIssues[key].volume === volNum) count++;
    });
    return count;
}

function updateVolumeBadges() {
    VOLUMES.forEach(function(vol) {
        var count = getVolumeSelectionCount(vol.num);
        // Update checklist badge
        var checkBadge = document.getElementById('vol-badge-' + vol.num);
        if (checkBadge) {
            checkBadge.textContent = count;
            checkBadge.className = count > 0 ? 'vol-badge has-count' : 'vol-badge';
        }
        // Update section header badge
        var sectionBadge = document.getElementById('vol-section-badge-' + vol.num);
        if (sectionBadge) {
            sectionBadge.textContent = count;
            sectionBadge.className = count > 0 ? 'vol-badge has-count' : 'vol-badge';
        }
    });
}

function toggleIssue(volNum, idx) {
    var key = 'v' + volNum + '-' + idx;
    var card = document.getElementById('card-' + key);
    if (STATE.selectedIssues[key]) {
        delete STATE.selectedIssues[key];
        card.classList.remove('selected');
    } else {
        var size = document.getElementById('size-' + key).value;
        STATE.selectedIssues[key] = { volume: volNum, issueIdx: idx, size: size };
        card.classList.add('selected');
    }
    updateVolumeBadges(); recalculate(); saveDraft();
}

function onIssueSizeChange(compositeId) {
    if (STATE.selectedIssues[compositeId]) {
        STATE.selectedIssues[compositeId].size = document.getElementById('size-' + compositeId).value;
    }
    saveDraft();
}

function selectAllVolume(volNum) {
    var defaultSize = document.getElementById('default-size').value;
    ISSUE_TEMPLATE.forEach(function(issue, idx) {
        var key = 'v' + volNum + '-' + idx;
        var size = STATE.customizeSizes && STATE.selectedIssues[key] ? STATE.selectedIssues[key].size : defaultSize;
        STATE.selectedIssues[key] = { volume: volNum, issueIdx: idx, size: size };
    });
    syncStateToDOM(); recalculate(); saveDraft();
}

function selectEveryOtherVolume(volNum) {
    var defaultSize = document.getElementById('default-size').value;
    ISSUE_TEMPLATE.forEach(function(issue, idx) {
        var key = 'v' + volNum + '-' + idx;
        if (idx % 2 === 0) {
            var size = STATE.customizeSizes && STATE.selectedIssues[key] ? STATE.selectedIssues[key].size : defaultSize;
            STATE.selectedIssues[key] = { volume: volNum, issueIdx: idx, size: size };
        } else { delete STATE.selectedIssues[key]; }
    });
    syncStateToDOM(); recalculate(); saveDraft();
}

function clearVolume(volNum) {
    ISSUE_TEMPLATE.forEach(function(issue, idx) { delete STATE.selectedIssues['v' + volNum + '-' + idx]; });
    syncStateToDOM(); recalculate(); saveDraft();
}

function clearAllIssues() {
    STATE.selectedIssues = {};
    syncStateToDOM(); recalculate(); saveDraft();
}

function selectIssuesFromStart(count) {
    var startVol = parseInt(document.getElementById('start-volume').value);
    var startIdx = parseInt(document.getElementById('start-issue').value);
    var defaultSize = document.getElementById('default-size').value;
    STATE.selectedIssues = {};
    var volIdx = VOLUMES.findIndex(function(v) { return v.num === startVol; });
    var issueIdx = startIdx;
    var selected = 0;
    while (selected < count && volIdx < VOLUMES.length) {
        var vol = VOLUMES[volIdx];
        var key = 'v' + vol.num + '-' + issueIdx;
        STATE.selectedIssues[key] = { volume: vol.num, issueIdx: issueIdx, size: defaultSize };
        selected++; issueIdx++;
        if (issueIdx >= 12) { issueIdx = 0; volIdx++; }
    }
    // Auto-check the relevant volume checkboxes and show those sections
    Object.keys(STATE.selectedIssues).forEach(function(key) {
        var vNum = STATE.selectedIssues[key].volume;
        STATE.expandedVolumes[vNum] = true;
    });
    syncStateToDOM();
}

function syncStateToDOM() {
    VOLUMES.forEach(function(vol) {
        ISSUE_TEMPLATE.forEach(function(issue, idx) {
            var key = 'v' + vol.num + '-' + idx;
            var card = document.getElementById('card-' + key);
            if (!card) return;
            var sizeEl = document.getElementById('size-' + key);
            if (STATE.selectedIssues[key]) {
                card.classList.add('selected');
                sizeEl.value = STATE.selectedIssues[key].size;
            } else {
                card.classList.remove('selected');
            }
        });
        // Sync volume checkboxes
        var checkbox = document.getElementById('vol-check-' + vol.num);
        var checkItem = document.getElementById('vol-check-item-' + vol.num);
        var section = document.getElementById('vol-section-' + vol.num);
        if (checkbox && checkItem && section) {
            var isChecked = !!STATE.expandedVolumes[vol.num];
            checkbox.checked = isChecked;
            if (isChecked) {
                checkItem.classList.add('checked');
                section.classList.add('visible');
            } else {
                checkItem.classList.remove('checked');
                section.classList.remove('visible');
            }
        }
    });
    updateVolumeBadges();
}

function toggleCustomize() {
    STATE.customizeSizes = document.getElementById('customize-sizes').checked;
    var defaultSize = document.getElementById('default-size').value;
    if (!STATE.customizeSizes) {
        Object.keys(STATE.selectedIssues).forEach(function(key) {
            STATE.selectedIssues[key].size = defaultSize;
            var sizeEl = document.getElementById('size-' + key);
            if (sizeEl) sizeEl.value = defaultSize;
        });
    }
    syncStateToDOM(); recalculate(); saveDraft();
}

function onDefaultSizeChange() {
    var def = document.getElementById('default-size').value;
    if (!STATE.customizeSizes) {
        Object.keys(STATE.selectedIssues).forEach(function(key) {
            STATE.selectedIssues[key].size = def;
        });
        VOLUMES.forEach(function(vol) {
            ISSUE_TEMPLATE.forEach(function(issue, idx) {
                var sizeEl = document.getElementById('size-v' + vol.num + '-' + idx);
                if (sizeEl) sizeEl.value = def;
            });
        });
    }
    recalculate(); updateTierComparison(); saveDraft();
}

// ============================================================
//  PACKAGE CHANGE
// ============================================================
function onPackageChange() {
    var pkg = document.getElementById('package-type').value;
    var emailCheck = document.getElementById('email-ads');
    var emailQtyRow = document.getElementById('email-qty-row');
    var emailIn = document.getElementById('email-in-season');
    var emailOff = document.getElementById('email-off-season');

    if (pkg === 'emailOnly') {
        clearAllIssues();
        emailCheck.checked = true;
        toggleDigitalCard('email-card', true);
        emailQtyRow.style.display = 'flex';
        recalculate(); saveDraft(); return;
    }

    switch (pkg) {
        case '5issue': selectIssuesFromStart(5); break;
        case 'annual': case 'comboA': selectIssuesFromStart(12); break;
        case 'combo6': selectIssuesFromStart(6); break;
        case 'combo3': selectIssuesFromStart(3); break;
    }

    if (pkg === 'comboA') {
        emailCheck.checked = true; toggleDigitalCard('email-card', true);
        emailQtyRow.style.display = 'flex';
        emailIn.value = 4; emailOff.value = 0; STATE.emailInSeason = 4; STATE.emailOffSeason = 0;
    } else if (pkg === 'combo6') {
        emailCheck.checked = true; toggleDigitalCard('email-card', true);
        emailQtyRow.style.display = 'flex';
        emailIn.value = 3; emailOff.value = 0; STATE.emailInSeason = 3; STATE.emailOffSeason = 0;
    } else if (pkg === 'combo3') {
        emailCheck.checked = true; toggleDigitalCard('email-card', true);
        emailQtyRow.style.display = 'flex';
        emailIn.value = 2; emailOff.value = 0; STATE.emailInSeason = 2; STATE.emailOffSeason = 0;
    }
    recalculate(); saveDraft();
}

// ============================================================
//  DIGITAL CARD TOGGLES
// ============================================================
function toggleDigitalCard(cardId, checked) {
    var card = document.getElementById(cardId);
    if (checked) card.classList.add('selected');
    else card.classList.remove('selected');
    if (cardId === 'email-card') {
        document.getElementById('email-qty-row').style.display = checked ? 'flex' : 'none';
        if (!checked) {
            document.getElementById('email-in-season').value = 0;
            document.getElementById('email-off-season').value = 0;
            STATE.emailInSeason = 0; STATE.emailOffSeason = 0;
        }
    }
}

// ============================================================
//  DISCOUNTS
// ============================================================
function addDiscount() {
    var container = document.getElementById('discounts-container');
    var row = document.createElement('div');
    row.className = 'discount-row';
    row.innerHTML =
        '<input type="text" placeholder="Discount description...">' +
        '<input type="number" placeholder="-$ amount" step="0.01" oninput="recalculate();saveDraft()">' +
        '<button type="button" class="remove-btn" onclick="this.parentElement.remove();recalculate();saveDraft();">&times;</button>';
    container.appendChild(row);
}

// ============================================================
//  PRICING ENGINE
// ============================================================
function getEmailTotalWeeks() {
    var inS = parseInt(document.getElementById('email-in-season').value) || 0;
    var offS = parseInt(document.getElementById('email-off-season').value) || 0;
    STATE.emailInSeason = inS; STATE.emailOffSeason = offS;
    return inS + offS;
}

function determineTier() {
    var pkg = document.getElementById('package-type').value;
    var issueCount = Object.keys(STATE.selectedIssues).length;
    var hasPreview = false;
    Object.keys(STATE.selectedIssues).forEach(function(key) {
        if (ISSUE_TEMPLATE[STATE.selectedIssues[key].issueIdx].isPreview) hasPreview = true;
    });
    var nonPreviewCount = hasPreview ? issueCount - 1 : issueCount;
    var emailQty = getEmailTotalWeeks();
    var emailChecked = document.getElementById('email-ads').checked;

    if (pkg === 'comboA') return { tier: 'comboA', label: 'Annual Combo', issueCount: issueCount };
    if (pkg === 'combo6') return { tier: 'combo6', label: '6-Month Combo', issueCount: issueCount };
    if (pkg === 'combo3') return { tier: 'combo3', label: '3-Month Combo', issueCount: issueCount };
    if (pkg === 'annual') return { tier: 'annual', label: '12-Issue Annual (23% Off)', issueCount: issueCount };
    if (pkg === '5issue') return { tier: '5issue', label: '5-Issue Print Package (20% Off)', issueCount: issueCount };
    if (pkg === 'emailOnly') return { tier: 'emailOnly', label: 'Email/Banner Only', issueCount: 0 };

    if (issueCount === 12 && emailChecked && emailQty >= 4) return { tier: 'comboA', label: 'Annual Combo (Auto-Detected)', issueCount: issueCount };
    if (issueCount >= 12) return { tier: 'annual', label: '12-Issue Annual (Auto-Detected)', issueCount: issueCount };
    if (issueCount >= 6 && emailChecked && emailQty >= 3) return { tier: 'combo6', label: '6-Month Combo (Auto-Detected)', issueCount: issueCount };
    if (nonPreviewCount >= 5 && (!emailChecked || emailQty < 2)) return { tier: '5issue', label: '5-Issue Package (Auto-Detected)', issueCount: issueCount };
    if (issueCount >= 3 && emailChecked && emailQty >= 2) return { tier: 'combo3', label: '3-Month Combo (Auto-Detected)', issueCount: issueCount };
    return { tier: 'single', label: 'Single Insertion', issueCount: issueCount };
}

function getRateForTier(tier) {
    switch (tier) {
        case 'comboA': return COMBO_ANNUAL;
        case 'combo6': return COMBO_6MO;
        case 'combo3': return COMBO_3MO;
        case 'annual': return ANNUAL_RATE;
        case '5issue': return FIVE_RATE;
        default: return SINGLE_RATE;
    }
}

function getIssuePriceFromState(key, tier) {
    var info = STATE.selectedIssues[key];
    if (!info) return 0;
    var issue = ISSUE_TEMPLATE[info.issueIdx];
    var size = info.size;
    var rate = getRateForTier(tier);
    if (tier === 'comboA' || tier === 'annual') return rate[size];
    if (issue.isPreview) return PREVIEW_RATE[size];
    return rate[size];
}

function calculateEmailTotal(isCombo, tier) {
    var inSeason = parseInt(document.getElementById('email-in-season').value) || 0;
    var offSeason = parseInt(document.getElementById('email-off-season').value) || 0;
    var totalWeeks = inSeason + offSeason;
    var blockNote = document.getElementById('email-block-note');

    if (isCombo) {
        var comboIncl = tier === 'comboA' ? 4 : (tier === 'combo6' ? 3 : 2);
        var remainIn = Math.max(0, inSeason - comboIncl);
        var remainCombo = Math.max(0, comboIncl - inSeason);
        var remainOff = Math.max(0, offSeason - remainCombo);
        var overage = remainIn * 500 + remainOff * 400;
        document.getElementById('email-total').textContent = overage > 0 ? comboIncl + ' incl. + $' + overage.toLocaleString() + ' overage' : 'Included in combo';
        blockNote.classList.remove('visible');
        return overage;
    }
    if (totalWeeks === 4) {
        blockNote.classList.add('visible');
        document.getElementById('email-total').textContent = '$1,800';
        return 1800;
    }
    blockNote.classList.remove('visible');
    var total = inSeason * 500 + offSeason * 400;
    document.getElementById('email-total').textContent = '$' + total.toLocaleString();
    return total;
}

// ============================================================
//  RECALCULATE
// ============================================================
function recalculate() {
    var tierInfo = determineTier();
    var tier = tierInfo.tier;
    var magazineTotal = 0;
    var issueCount = Object.keys(STATE.selectedIssues).length;

    Object.keys(STATE.selectedIssues).forEach(function(key) {
        var price = getIssuePriceFromState(key, tier);
        var priceEl = document.getElementById('price-' + key);
        if (priceEl) priceEl.textContent = '$' + price.toLocaleString();
        magazineTotal += price;
    });

    VOLUMES.forEach(function(vol) {
        ISSUE_TEMPLATE.forEach(function(issue, idx) {
            var key = 'v' + vol.num + '-' + idx;
            if (!STATE.selectedIssues[key]) {
                var priceEl = document.getElementById('price-' + key);
                if (priceEl) priceEl.textContent = '\u2014';
            }
        });
    });

    var isCombo = tier === 'comboA' || tier === 'combo6' || tier === 'combo3';
    var bannerTotal = 0;
    var emailTotal = 0;

    if (document.getElementById('web-banner').checked) {
        bannerTotal = STATE.bannerPrice;
    }

    if (document.getElementById('email-ads').checked) {
        emailTotal = calculateEmailTotal(isCombo, tier);
    } else {
        document.getElementById('email-total').textContent = '$0';
        document.getElementById('email-block-note').classList.remove('visible');
    }

    if (tier === 'emailOnly' && document.getElementById('email-ads').checked) {
        emailTotal = calculateEmailTotal(false, tier);
    }

    var subtotal = magazineTotal + emailTotal + bannerTotal;

    var totalDiscounts = 0;
    var discountLines = [];
    document.querySelectorAll('#discounts-container .discount-row').forEach(function(row) {
        var desc = row.querySelector('input[type="text"]').value || 'Discount';
        var amt = parseFloat(row.querySelector('input[type="number"]').value) || 0;
        if (amt !== 0) {
            totalDiscounts += Math.abs(amt);
            discountLines.push({ label: desc, amount: -Math.abs(amt) });
        }
    });

    var prepayAmt = 0;
    if (document.getElementById('prepay-discount').checked) {
        prepayAmt = Math.round(subtotal * 0.07);
        totalDiscounts += prepayAmt;
        discountLines.push({ label: '7% Prepayment Discount', amount: -prepayAmt });
        document.getElementById('prepay-savings').textContent = '(-$' + prepayAmt.toLocaleString() + ')';
    } else {
        document.getElementById('prepay-savings').textContent = '';
    }

    var grandTotal = subtotal - totalDiscounts;

    var html = '';
    if (tierInfo.label && tier !== 'single' && tier !== 'emailOnly') {
        html += '<div class="total-line"><span class="label">Pricing Tier</span><span>' + cleanTierLabel(tierInfo.label) + '</span></div>';
    }
    if (issueCount > 0) {
        var defaultSize = document.getElementById('default-size').value;
        html += '<div class="total-line"><span class="label">' + issueCount + ' Issues (' + SIZE_LABELS[defaultSize] + (STATE.customizeSizes ? ', customized' : '') + ')</span><span>$' + magazineTotal.toLocaleString() + '</span></div>';
    }
    if (bannerTotal > 0) {
        html += '<div class="total-line"><span class="label">Website Banner</span><span>$' + bannerTotal.toLocaleString() + '</span></div>';
    }
    if (emailTotal > 0 && !isCombo) {
        html += '<div class="total-line"><span class="label">Email Ads</span><span>$' + emailTotal.toLocaleString() + '</span></div>';
    }
    if (isCombo && document.getElementById('email-ads').checked) {
        var comboE2 = tier === 'comboA' ? 4 : (tier === 'combo6' ? 3 : 2);
        if (emailTotal > 0) {
            html += '<div class="total-line"><span class="label">Email Ads (' + comboE2 + ' incl. + overage)</span><span>$' + emailTotal.toLocaleString() + '</span></div>';
        } else {
            html += '<div class="total-line"><span class="label">Email Ads (' + comboE2 + ' wks included in combo)</span><span>$0</span></div>';
        }
    }

    html += '<div class="total-line subtotal"><span class="label">Subtotal</span><span>$' + subtotal.toLocaleString() + '</span></div>';
    discountLines.forEach(function(d) {
        html += '<div class="total-line discount"><span class="label">' + d.label + '</span><span>-$' + Math.abs(d.amount).toLocaleString() + '</span></div>';
    });
    html += '<div class="total-line grand-total"><span class="label">Total</span><span>$' + grandTotal.toLocaleString() + '</span></div>';

    if (issueCount > 0) {
        var perMonth = Math.round(grandTotal / issueCount);
        html += '<div class="total-line" style="opacity:0.6;font-size:13px;"><span class="label">\u2248 Per Month</span><span>$' + perMonth.toLocaleString() + '/mo</span></div>';
    }
    if (tier !== 'single' && tier !== 'emailOnly' && issueCount > 0) {
        var singleTotal = calcSingleRateTotal();
        var savings = singleTotal - grandTotal;
        if (savings > 0) {
            html += '<div class="total-line" style="color:#2d8a4e;font-size:13px;font-weight:700;"><span class="label">You save vs. single rates</span><span>$' + savings.toLocaleString() + '</span></div>';
        }
    }

    document.getElementById('totals-lines').innerHTML = html;
    updateTierComparison();
}

// ============================================================
//  HELPERS
// ============================================================
function toTitleCase(str) {
    if (!str) return '';
    return str.replace(/\w\S*/g, function(txt) {
        return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
    });
}

function cleanTierLabel(label) {
    return label.replace(/\s*\(Auto-Detected\)/g, '');
}

function calcSingleRateTotal() {
    var total = 0;
    Object.keys(STATE.selectedIssues).forEach(function(key) {
        var info = STATE.selectedIssues[key];
        var issue = ISSUE_TEMPLATE[info.issueIdx];
        var size = info.size;
        total += issue.isPreview ? PREVIEW_RATE[size] : SINGLE_RATE[size];
    });
    if (document.getElementById('email-ads').checked) {
        var inS = parseInt(document.getElementById('email-in-season').value) || 0;
        var offS = parseInt(document.getElementById('email-off-season').value) || 0;
        total += inS * 500 + offS * 400;
    }
    if (document.getElementById('web-banner').checked) {
        total += STATE.bannerPrice;
    }
    return total;
}

// Get volume range string from selected issues
function getVolumeRange() {
    var vols = {};
    Object.keys(STATE.selectedIssues).forEach(function(key) {
        vols[STATE.selectedIssues[key].volume] = true;
    });
    var volNums = Object.keys(vols).map(Number).sort(function(a,b){return a-b;});
    if (volNums.length === 0) return 'Volume 32';
    if (volNums.length === 1) return 'Volume ' + volNums[0];
    return 'Volumes ' + volNums[0] + '\u2013' + volNums[volNums.length - 1];
}

// ============================================================
//  TIER COMPARISON PANEL
// ============================================================
function updateTierComparison() {
    var size = document.getElementById('default-size').value;
    var tierInfo = determineTier();
    var currentTier = tierInfo.tier;
    var tiers = [
        { key: 'single', name: 'Single Issue', rate: SINGLE_RATE[size], per: '/issue' },
        { key: '5issue', name: '5-Issue Package', rate: FIVE_RATE[size], per: '/issue' },
        { key: 'annual', name: '12-Issue Annual', rate: ANNUAL_RATE[size], per: '/mo' },
        { key: 'combo3', name: '3-Mo Combo', rate: COMBO_3MO[size], per: '/mo' },
        { key: 'combo6', name: '6-Mo Combo', rate: COMBO_6MO[size], per: '/mo' },
        { key: 'comboA', name: 'Annual Combo', rate: COMBO_ANNUAL[size], per: '/mo' }
    ];
    var singleRate = SINGLE_RATE[size];
    var html = '<table class="tier-table"><thead><tr><th>Package</th><th>Rate (' + SIZE_LABELS[size] + ')</th><th>Savings vs Single</th></tr></thead><tbody>';
    tiers.forEach(function(t) {
        var isActive = t.key === currentTier;
        var savings = singleRate - t.rate;
        var savingsStr = savings > 0 ? ('$' + savings.toLocaleString() + t.per) : '\u2014';
        var pct = savings > 0 ? ' (' + Math.round(savings / singleRate * 100) + '%)' : '';
        html += '<tr class="' + (isActive ? 'active-tier' : '') + '"><td>' + t.name + '</td><td>$' + t.rate.toLocaleString() + t.per + '</td><td>' + savingsStr + pct + '</td></tr>';
    });
    html += '</tbody></table>';
    document.getElementById('tier-panel-body').innerHTML = html;
}

// ============================================================
//  PDF GENERATION (Multi-Volume)
// ============================================================
function generatePDF() {
    var jsPDF = window.jspdf.jsPDF;
    var doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'letter' });
    var pw = doc.internal.pageSize.getWidth();
    var ph = doc.internal.pageSize.getHeight();
    var m = 14;
    var y = 0;
    var rightCol = pw - m;
    var totalPages = 2; // will be updated for dynamic page count

    function checkPageBreak(neededHeight) {
        if (y + neededHeight > ph - 20) {
            addFooter(doc.internal.getNumberOfPages());
            doc.addPage();
            y = 14;
            return true;
        }
        return false;
    }

    function addFooter(pageNum) {
        doc.setFontSize(6.5);
        doc.setTextColor(150, 150, 150);
        doc.setFont('helvetica', 'normal');
        doc.text('WIN Magazine \u2022 PO Box 194 / Newton, IA 50208 \u2022 Gina@win-magazine.com \u2022 641-792-4436', pw / 2, ph - 7, { align: 'center' });
        doc.text('WIN Magazine reserves the right to refuse any ad copy.', pw / 2, ph - 4, { align: 'center' });
    }

    function addSignatures(startY, signedBy, advName, contactName) {
        var sy = startY;
        doc.setDrawColor(196, 30, 58);
        doc.setLineWidth(0.4);
        doc.line(m, sy, pw - m, sy);
        sy += 5;
        doc.setTextColor(0, 0, 0);
        var half = pw / 2 - 2;
        doc.setFontSize(8);
        doc.setFont('helvetica', 'bold');
        doc.text('WIN Magazine Representative:', m, sy);
        doc.text('Company Representative (' + advName + '):', half + 6, sy);
        sy += 7;
        doc.setDrawColor(0, 0, 0);
        doc.setLineWidth(0.25);
        doc.line(m, sy, m + 62, sy);
        doc.line(m + 68, sy, half - 2, sy);
        doc.line(half + 6, sy, half + 68, sy);
        doc.line(half + 74, sy, pw - m, sy);
        sy += 3.5;
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(6.5);
        doc.text('Signature', m, sy);
        doc.text('Date', m + 68, sy);
        doc.text('Signature', half + 6, sy);
        doc.text('Date', half + 74, sy);
        sy += 3;
        doc.setFontSize(8);
        doc.setFont('helvetica', 'italic');
        doc.text('Thanks ' + contactName + ', ' + signedBy, m, sy);
        return sy + 2;
    }

    var rawAdvName = document.getElementById('advertiser-name').value || '';
    var rawContact = document.getElementById('contact-name').value || '';
    var advName = toTitleCase(rawAdvName) || '\u2014';
    var contactName = toTitleCase(rawContact) || '\u2014';
    var acctNum = document.getElementById('acct-number').value || '\u2014';
    var contactEmail = document.getElementById('contact-email').value || '\u2014';
    var signedBy = document.getElementById('signed-by').value || 'Bryan';
    var signDate = document.getElementById('sign-date').value || '';
    var orderDate = signDate || new Date().toISOString().slice(0, 10);
    var tierInfo = determineTier();
    var tierLabel = cleanTierLabel(tierInfo.label);
    var volRange = getVolumeRange();
    var volRangeYears = '';
    var volNums = [];
    Object.keys(STATE.selectedIssues).forEach(function(key) {
        var vn = STATE.selectedIssues[key].volume;
        if (volNums.indexOf(vn) === -1) volNums.push(vn);
    });
    volNums.sort(function(a,b){return a-b;});
    if (volNums.length > 0) {
        var firstYear = 2025 + (volNums[0] - 32);
        var lastYear = 2025 + (volNums[volNums.length-1] - 32) + 1;
        volRangeYears = ' (' + firstYear + '\u2013' + lastYear + ')';
    }

    // PAGE 1 HEADER
    doc.setFillColor(26, 26, 26);
    doc.rect(0, 0, pw, 20, 'F');
    doc.setFillColor(196, 30, 58);
    doc.rect(0, 20, pw, 2, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(13);
    doc.text('WIN Magazine Insertion Order \u2014 ' + volRange + volRangeYears, m, 13);
    doc.setFontSize(7);
    doc.setFont('helvetica', 'normal');
    doc.text('3-Year Fixed-Price Renewal Option', pw - m, 9, { align: 'right' });
    doc.text('PO Box 194 / Newton, IA 50208 / P: 641-792-4436', pw - m, 14, { align: 'right' });
    y = 27;

    // Advertiser info
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(9);
    doc.setFont('helvetica', 'bold');
    doc.text('Advertiser:', m, y);
    doc.setFont('helvetica', 'normal');
    doc.text(advName, m + 25, y);
    doc.setFont('helvetica', 'bold');
    doc.text('Acct #:', pw / 2 + 10, y);
    doc.setFont('helvetica', 'normal');
    doc.text(acctNum, pw / 2 + 27, y);
    y += 5;
    doc.setFont('helvetica', 'bold');
    doc.text('Contact:', m, y);
    doc.setFont('helvetica', 'normal');
    doc.text(contactName, m + 25, y);
    doc.setFont('helvetica', 'bold');
    doc.text('Email:', pw / 2 + 10, y);
    doc.setFont('helvetica', 'normal');
    doc.text(contactEmail, pw / 2 + 27, y);
    y += 5;
    doc.setFont('helvetica', 'bold');
    doc.text('Date:', m, y);
    doc.setFont('helvetica', 'normal');
    doc.text(orderDate, m + 25, y);
    doc.setFont('helvetica', 'bold');
    doc.text('Package:', pw / 2 + 10, y);
    doc.setFont('helvetica', 'normal');
    doc.text(tierLabel, pw / 2 + 30, y);
    y += 3;

    if (document.getElementById('new-customer').checked) {
        var addr = document.getElementById('billing-address').value || '';
        if (addr) {
            y += 2;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(8);
            doc.text('Billing:', m, y);
            doc.setFont('helvetica', 'normal');
            doc.text(addr, m + 25, y);
            y += 4;
        }
    }

    y += 1;
    doc.setDrawColor(196, 30, 58);
    doc.setLineWidth(0.4);
    doc.line(m, y, pw - m, y);
    y += 4;

    // GROUP ISSUES BY VOLUME
    var issuesByVolume = {};
    var magazineTotal = 0;
    Object.keys(STATE.selectedIssues).forEach(function(key) {
        var info = STATE.selectedIssues[key];
        if (!issuesByVolume[info.volume]) issuesByVolume[info.volume] = [];
        var price = getIssuePriceFromState(key, tierInfo.tier);
        magazineTotal += price;
        issuesByVolume[info.volume].push({
            volNum: info.volume,
            issueIdx: info.issueIdx,
            issue: ISSUE_TEMPLATE[info.issueIdx],
            size: info.size,
            price: price
        });
    });

    // Sort issues within each volume by issue index
    Object.keys(issuesByVolume).forEach(function(v) {
        issuesByVolume[v].sort(function(a,b) { return a.issueIdx - b.issueIdx; });
    });

    var sortedVols = Object.keys(issuesByVolume).map(Number).sort(function(a,b){return a-b;});

    if (sortedVols.length > 0) {
        // Table header
        doc.setFillColor(240, 240, 240);
        doc.rect(m, y - 3, pw - 2 * m, 5, 'F');
        doc.setFontSize(7.5);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 0, 0);
        doc.text('#', m + 1, y);
        doc.text('Issue', m + 10, y);
        doc.text('Ad Size', m + 45, y);
        doc.text('Rate', rightCol - 2, y, { align: 'right' });
        y += 4.5;

        sortedVols.forEach(function(volNum) {
            var volLabel = VOLUMES.find(function(v){return v.num===volNum;}).label;
            checkPageBreak(8);
            // Volume header row
            doc.setFillColor(230, 230, 230);
            doc.rect(m, y - 3, pw - 2 * m, 5, 'F');
            doc.setFontSize(7.5);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(80, 80, 80);
            doc.text(volLabel, m + 1, y);
            y += 5;
            doc.setTextColor(0, 0, 0);

            issuesByVolume[volNum].forEach(function(item) {
                checkPageBreak(5);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                var pdfIssueCode = item.volNum + String(item.issue.num).padStart(2, '0');
                doc.text(pdfIssueCode, m + 1, y);
                doc.text(item.issue.name + (item.issue.isPreview ? ' (Preview)' : ''), m + 16, y);
                doc.text(SIZE_LABELS[item.size], m + 45, y);
                doc.text('$' + item.price.toLocaleString(), rightCol - 2, y, { align: 'right' });
                y += 4.2;
            });
        });

        // Magazine subtotal
        doc.setDrawColor(180, 180, 180);
        doc.setLineWidth(0.2);
        doc.line(m + 45, y - 0.5, rightCol, y - 0.5);
        y += 2.5;
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(8);
        doc.text('Magazine Total (' + Object.keys(STATE.selectedIssues).length + ' issues)', m + 45, y);
        doc.text('$' + magazineTotal.toLocaleString(), rightCol - 2, y, { align: 'right' });
        y += 5;
    }

    // Digital ads
    var isCombo = tierInfo.tier === 'comboA' || tierInfo.tier === 'combo6' || tierInfo.tier === 'combo3';
    var hasBanner = document.getElementById('web-banner').checked;
    var hasEmail = document.getElementById('email-ads').checked;
    var emailInS = parseInt(document.getElementById('email-in-season').value) || 0;
    var emailOffS = parseInt(document.getElementById('email-off-season').value) || 0;
    var emailQty = emailInS + emailOffS;
    var comboIncluded = tierInfo.tier === 'comboA' ? 4 : (tierInfo.tier === 'combo6' ? 3 : (tierInfo.tier === 'combo3' ? 2 : 0));

    if (hasBanner || hasEmail) {
        checkPageBreak(20);
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(8);
        doc.text('DIGITAL', m, y);
        y += 4;
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(8);

        if (hasBanner) {
            var pdfBannerStart = document.getElementById('banner-start-date').value;
            var pdfBannerEnd = document.getElementById('banner-end-date').value;
            var bannerDesc = 'Website Banner (Annual)';
            if (pdfBannerStart && pdfBannerEnd) {
                bannerDesc = 'Website Banner (' + new Date(pdfBannerStart + 'T00:00:00').toLocaleDateString('en-US', {month:'short',year:'numeric'}) + ' \u2013 ' + new Date(pdfBannerEnd + 'T00:00:00').toLocaleDateString('en-US', {month:'short',year:'numeric'}) + ')';
            }
            doc.text(bannerDesc, m + 1, y);
            doc.text('$' + STATE.bannerPrice.toLocaleString(), rightCol - 2, y, { align: 'right' });
            y += 4;
        }
        if (hasEmail) {
            if (isCombo && emailQty <= comboIncluded) {
                doc.text('Email Newsletter (' + comboIncluded + ' wks, included in combo)', m + 1, y);
                doc.text('Included', rightCol - 2, y, { align: 'right' });
                y += 4;
            } else if (isCombo && emailQty > comboIncluded) {
                doc.text('Email Newsletter (' + comboIncluded + ' wks, included)', m + 1, y);
                doc.text('Included', rightCol - 2, y, { align: 'right' });
                y += 4;
                var remainIn = Math.max(0, emailInS - comboIncluded);
                var remainCombo = Math.max(0, comboIncluded - emailInS);
                var remainOff = Math.max(0, emailOffS - remainCombo);
                var overagePrice = remainIn * 500 + remainOff * 400;
                doc.text('Additional Email Ads (overage)', m + 1, y);
                doc.text('$' + overagePrice.toLocaleString(), rightCol - 2, y, { align: 'right' });
                y += 4;
            } else if (emailQty > 0) {
                var ePrice = emailQty === 4 ? 1800 : emailInS * 500 + emailOffS * 400;
                var desc = emailInS > 0 && emailOffS > 0 ? emailInS + ' in-season + ' + emailOffS + ' off-season' : emailQty + ' wks';
                doc.text('Email Newsletter (' + desc + ')', m + 1, y);
                doc.text('$' + ePrice.toLocaleString(), rightCol - 2, y, { align: 'right' });
                y += 4;
            }
        }
        var bannerStart = document.getElementById('banner-start-date').value;
        var bannerEnd = document.getElementById('banner-end-date').value;
        if (bannerStart || bannerEnd) {
            doc.setFontSize(7);
            var periodStr = 'Period: ';
            if (bannerStart && bannerEnd) {
                periodStr += new Date(bannerStart + 'T00:00:00').toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'}) + ' \u2013 ' + new Date(bannerEnd + 'T00:00:00').toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'});
            } else if (bannerStart) {
                periodStr += 'Starting ' + new Date(bannerStart + 'T00:00:00').toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'});
            } else {
                periodStr += 'Ending ' + new Date(bannerEnd + 'T00:00:00').toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'});
            }
            doc.text(periodStr, m + 1, y);
            y += 4;
        }
        y += 1;
    }

    // Additional options
    var optDesign = document.getElementById('opt-design').checked;
    var optNcaa = document.getElementById('opt-ncaa').checked;
    if (optDesign || optNcaa) {
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(7.5);
        var opts = [];
        if (optDesign) opts.push('Design needed');
        if (optNcaa) opts.push('NCAA/Big 12 Program Ad');
        doc.text('Additional: ' + opts.join(' | '), m, y);
        y += 4;
    }

    // Notes
    var notes = document.getElementById('notes').value;
    if (notes) {
        doc.setFont('helvetica', 'italic');
        doc.setFontSize(7.5);
        var noteLines = doc.splitTextToSize('Notes: ' + notes, pw - 2 * m);
        doc.text(noteLines, m, y);
        y += noteLines.length * 3.5 + 2;
    }

    // TOTALS
    var pdfBanner = hasBanner ? STATE.bannerPrice : 0;
    var pdfEmail = 0;
    if (hasEmail) {
        if (isCombo && emailQty > comboIncluded) {
            var rIn = Math.max(0, emailInS - comboIncluded);
            var rCombo = Math.max(0, comboIncluded - emailInS);
            var rOff = Math.max(0, emailOffS - rCombo);
            pdfEmail = rIn * 500 + rOff * 400;
        } else if (!isCombo) {
            pdfEmail = emailQty === 4 ? 1800 : emailInS * 500 + emailOffS * 400;
        }
        if (tierInfo.tier === 'emailOnly') {
            pdfEmail = emailQty === 4 ? 1800 : emailInS * 500 + emailOffS * 400;
        }
    }
    var pdfSubtotal = magazineTotal + pdfBanner + pdfEmail;

    var pdfDiscountItems = [];
    document.querySelectorAll('#discounts-container .discount-row').forEach(function(row) {
        var desc = row.querySelector('input[type="text"]').value || 'Discount';
        var amt = parseFloat(row.querySelector('input[type="number"]').value) || 0;
        if (amt !== 0) pdfDiscountItems.push({ label: desc, amount: Math.abs(amt) });
    });
    if (document.getElementById('prepay-discount').checked) {
        pdfDiscountItems.push({ label: '7% Prepay Discount', amount: Math.round(pdfSubtotal * 0.07) });
    }
    var pdfTotalDiscount = 0;
    pdfDiscountItems.forEach(function(d) { pdfTotalDiscount += d.amount; });
    var pdfGrandTotal = pdfSubtotal - pdfTotalDiscount;
    var singleRateTotal = calcSingleRateTotal();
    var savingsAmount = singleRateTotal - pdfGrandTotal;

    checkPageBreak(35);
    y += 1;
    doc.setDrawColor(196, 30, 58);
    doc.setLineWidth(0.4);
    doc.line(m, y, pw - m, y);
    y += 4;

    var totalsX = pw / 2 + 20;
    doc.setFontSize(8);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(0, 0, 0);
    doc.text('Subtotal:', totalsX, y);
    doc.text('$' + pdfSubtotal.toLocaleString(), rightCol - 2, y, { align: 'right' });
    y += 4;

    pdfDiscountItems.forEach(function(d) {
        doc.setTextColor(45, 138, 78);
        doc.text(d.label + ':', totalsX, y);
        doc.text('-$' + d.amount.toLocaleString(), rightCol - 2, y, { align: 'right' });
        y += 4;
    });

    doc.setDrawColor(0, 0, 0);
    doc.setLineWidth(0.3);
    doc.line(totalsX, y - 1, rightCol, y - 1);
    y += 2;
    doc.setTextColor(0, 0, 0);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(11);
    doc.text('Total:', totalsX, y);
    doc.text('$' + pdfGrandTotal.toLocaleString(), rightCol - 2, y, { align: 'right' });
    y += 4;

    doc.setFont('helvetica', 'normal');
    doc.setFontSize(7.5);
    var issueCount = Object.keys(STATE.selectedIssues).length;
    if (issueCount > 0) {
        var perMonth = Math.round(pdfGrandTotal / issueCount);
        doc.setTextColor(80, 80, 80);
        doc.text('~ $' + perMonth.toLocaleString() + '/month', rightCol - 2, y, { align: 'right' });
        y += 3.5;
    }
    if (savingsAmount > 0 && tierInfo.tier !== 'single' && tierInfo.tier !== 'emailOnly') {
        doc.setTextColor(45, 138, 78);
        doc.setFont('helvetica', 'bold');
        doc.text('You save $' + savingsAmount.toLocaleString() + ' vs. single rates', rightCol - 2, y, { align: 'right' });
        y += 3.5;
    }
    y += 1;

    doc.setTextColor(100, 100, 100);
    doc.setFontSize(7);
    doc.setFont('helvetica', 'normal');
    doc.text('NET 30. Finance charge 1.5%/mo on balances past 30 days. 3-Year Fixed-Price locks in current pricing.', m, y);
    y += 5;

    // PAGE 1 SIGNATURES
    checkPageBreak(25);
    addSignatures(y, signedBy, advName, contactName);
    addFooter(1);

    // TERMS & CONDITIONS PAGE
    doc.addPage();
    y = 0;
    doc.setFillColor(26, 26, 26);
    doc.rect(0, 0, pw, 18, 'F');
    doc.setFillColor(196, 30, 58);
    doc.rect(0, 18, pw, 2, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(12);
    doc.text('Terms & Conditions \u2014 ' + advName, m, 12);
    doc.setFontSize(7);
    doc.setFont('helvetica', 'normal');
    doc.text('Order Date: ' + orderDate, pw - m, 12, { align: 'right' });
    y = 26;

    doc.setTextColor(0, 0, 0);
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(8.5);

    var terms = [
        '1. PAYMENT: All invoices are due NET 30 from invoice date. A finance charge of 1.5% per month (18% annually) will be applied to all balances past 30 days.',
        '2. CANCELLATION: Advertiser may cancel with 30 days written notice. Cancellation of annual or multi-issue packages before completion voids package pricing; advertiser will be invoiced at single insertion rates for issues already published.',
        '3. AD MATERIALS: Advertiser is responsible for providing print-ready ad materials by the published deadlines. WIN Magazine is not responsible for errors in advertiser-supplied materials.',
        '4. PLACEMENT: WIN Magazine will make reasonable efforts to honor premium placement requests but does not guarantee specific positioning unless confirmed in writing.',
        '5. CONTENT: WIN Magazine reserves the right to refuse any advertising copy that it deems inappropriate, misleading, or not in keeping with the publication\'s standards.',
        '6. LIABILITY: WIN Magazine\'s liability for errors or omissions shall not exceed the cost of the ad space in which the error occurred. Claims must be made within 30 days of publication.',
        '7. 3-YEAR FIXED PRICE: This insertion order locks in current pricing for up to three (3) consecutive publication years, provided the advertiser maintains continuous participation. Pricing reverts to current rates if participation lapses.',
        '8. DIGITAL ADS: Website banner and email newsletter ad placements are subject to availability. Digital ad metrics and placement reports available upon request.',
        '9. INDEMNIFICATION: Advertiser agrees to indemnify and hold harmless WIN Magazine from any claims arising from the content of advertisements placed by the advertiser.',
        '10. ENTIRE AGREEMENT: This insertion order, together with these terms and conditions, constitutes the entire agreement between the parties.'
    ];

    terms.forEach(function(term) {
        var tLines = doc.splitTextToSize(term, pw - 2 * m);
        doc.text(tLines, m, y);
        y += tLines.length * 4 + 2.5;
    });

    y += 3;
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(8.5);
    doc.text('By signing below, both parties agree to the insertion order and terms stated above.', m, y);
    y += 5;

    addSignatures(y, signedBy, advName, contactName);
    addFooter(doc.internal.getNumberOfPages());

    // Add page numbers
    var numPages = doc.internal.getNumberOfPages();
    for (var i = 1; i <= numPages; i++) {
        doc.setPage(i);
        doc.setFontSize(6.5);
        doc.setTextColor(150, 150, 150);
        doc.setFont('helvetica', 'normal');
        doc.text('Page ' + i + ' of ' + numPages, pw - m, ph - 4, { align: 'right' });
    }

    return doc;
}

// ============================================================
//  PDF PREVIEW MODAL
// ============================================================
var pendingDoc = null;
var pendingFilename = '';

function closePdfModal() {
    document.getElementById('pdf-modal').classList.remove('visible');
    document.getElementById('pdf-iframe').src = '';
    pendingDoc = null;
    pendingFilename = '';
}

function sendToGina() {
    if (!pendingDoc) return;
    var btn = document.getElementById('btn-send-gina');
    var statusEl = document.getElementById('status-msg');
    btn.textContent = 'Sending...';
    btn.disabled = true;

    try {
        pendingDoc.save(pendingFilename);
        var pdfBase64 = pendingDoc.output('datauristring').split(',')[1];
        var tierInfo = determineTier();
        var selectedIssues = [];
        Object.keys(STATE.selectedIssues).forEach(function(key) {
            var info = STATE.selectedIssues[key];
            var issueNum = ISSUE_TEMPLATE[info.issueIdx].num;
            selectedIssues.push({
                volume: info.volume,
                issueCode: info.volume + String(issueNum).padStart(2, '0'),
                issue: ISSUE_TEMPLATE[info.issueIdx].name,
                size: SIZE_LABELS[info.size],
                price: getIssuePriceFromState(key, tierInfo.tier)
            });
        });

        var payload = {
            advertiser: document.getElementById('advertiser-name').value,
            acctNumber: document.getElementById('acct-number').value,
            contact: document.getElementById('contact-name').value,
            email: document.getElementById('contact-email').value,
            billingAddress: document.getElementById('billing-address').value,
            package: cleanTierLabel(tierInfo.label),
            defaultSize: SIZE_LABELS[document.getElementById('default-size').value],
            issues: selectedIssues,
            webBanner: document.getElementById('web-banner').checked,
            bannerPrice: STATE.bannerPrice,
            emailAds: document.getElementById('email-ads').checked,
            emailInSeason: STATE.emailInSeason,
            emailOffSeason: STATE.emailOffSeason,
            bannerStartDate: document.getElementById('banner-start-date').value,
            bannerEndDate: document.getElementById('banner-end-date').value,
            designNeeded: document.getElementById('opt-design').checked,
            ncaaAd: document.getElementById('opt-ncaa').checked,
            prepayDiscount: document.getElementById('prepay-discount').checked,
            notes: document.getElementById('notes').value,
            signedBy: document.getElementById('signed-by').value,
            signDate: document.getElementById('sign-date').value,
            total: document.getElementById('totals-lines').querySelector('.grand-total') ?
                   document.getElementById('totals-lines').querySelector('.grand-total').lastChild.textContent : '$0',
            filename: pendingFilename,
            pdfBase64: pdfBase64,
            timestamp: new Date().toISOString()
        };

        if (WEBHOOK_URL) {
            fetch(WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(function(resp) {
                if (resp.ok) {
                    statusEl.className = 'status-message success';
                    statusEl.textContent = 'PDF generated & sent to Gina: ' + pendingFilename;
                } else {
                    statusEl.className = 'status-message error';
                    statusEl.textContent = 'PDF downloaded but webhook failed (status ' + resp.status + '). Send manually.';
                }
            }).catch(function(err) {
                statusEl.className = 'status-message error';
                statusEl.textContent = 'PDF downloaded but webhook error: ' + err.message + '. Send manually.';
            });
        }

        localStorage.removeItem(DRAFT_KEY);
    } catch (error) {
        statusEl.className = 'status-message error';
        statusEl.textContent = 'Error: ' + error.message;
    } finally {
        closePdfModal();
        btn.textContent = 'Send to Gina';
        btn.disabled = false;
    }
}

// ============================================================
//  SUBMIT (Preview Flow)
// ============================================================
function submitForm() {
    var advName = document.getElementById('advertiser-name').value;
    if (!advName) { alert('Please enter an advertiser name.'); return; }

    var btn = document.getElementById('submit-btn');
    btn.textContent = 'Generating...';
    btn.disabled = true;

    try {
        pendingDoc = generatePDF();
        pendingFilename = 'WIN_IO_' + advName.replace(/[^a-zA-Z0-9]/g, '_') + '_' + new Date().toISOString().slice(0, 10) + '.pdf';
        var blobUrl = pendingDoc.output('bloburl');
        document.getElementById('pdf-iframe').src = blobUrl;
        document.getElementById('pdf-modal').classList.add('visible');
    } catch (error) {
        console.error('PDF error:', error);
        document.getElementById('status-msg').className = 'status-message error';
        document.getElementById('status-msg').textContent = 'Error generating PDF: ' + error.message;
    } finally {
        btn.textContent = 'Generate PDF';
        btn.disabled = false;
    }
}

// ============================================================
//  DRAFT SAVING (localStorage)
// ============================================================
function saveDraft() {
    try {
        var draft = {
            state: JSON.parse(JSON.stringify(STATE)),
            fields: {
                advertiserName: document.getElementById('advertiser-name').value,
                acctNumber: document.getElementById('acct-number').value,
                contactName: document.getElementById('contact-name').value,
                contactEmail: document.getElementById('contact-email').value,
                billingAddress: document.getElementById('billing-address').value,
                newCustomer: document.getElementById('new-customer').checked,
                packageType: document.getElementById('package-type').value,
                defaultSize: document.getElementById('default-size').value,
                startVolume: document.getElementById('start-volume').value,
                startIssue: document.getElementById('start-issue').value,
                customizeSizes: document.getElementById('customize-sizes').checked,
                webBanner: document.getElementById('web-banner').checked,
                emailAds: document.getElementById('email-ads').checked,
                emailInSeason: document.getElementById('email-in-season').value,
                emailOffSeason: document.getElementById('email-off-season').value,
                bannerPrice: document.getElementById('banner-price-input').value,
                bannerStartDate: document.getElementById('banner-start-date').value,
                bannerEndDate: document.getElementById('banner-end-date').value,
                optDesign: document.getElementById('opt-design').checked,
                optNcaa: document.getElementById('opt-ncaa').checked,
                prepayDiscount: document.getElementById('prepay-discount').checked,
                notes: document.getElementById('notes').value,
                signedBy: document.getElementById('signed-by').value,
                signDate: document.getElementById('sign-date').value
            },
            discounts: []
        };
        document.querySelectorAll('#discounts-container .discount-row').forEach(function(row) {
            draft.discounts.push({
                desc: row.querySelector('input[type="text"]').value,
                amt: row.querySelector('input[type="number"]').value
            });
        });
        localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
    } catch(e) { /* silent */ }
}

function attachAutoSave() {
    var form = document.getElementById('io-form');
    form.addEventListener('input', function() { saveDraft(); });
    form.addEventListener('change', function() { saveDraft(); });
}

function hasDraft() {
    try { return !!localStorage.getItem(DRAFT_KEY); } catch(e) { return false; }
}

function getDraftAdvertiserName() {
    try {
        var d = JSON.parse(localStorage.getItem(DRAFT_KEY));
        return d && d.fields && d.fields.advertiserName ? d.fields.advertiserName : 'Unknown';
    } catch(e) { return 'Unknown'; }
}

function restoreDraft() {
    document.getElementById('draft-modal').classList.remove('visible');
    try {
        var draft = JSON.parse(localStorage.getItem(DRAFT_KEY));
        if (!draft) { init(); return; }

        // Restore STATE
        STATE = draft.state;

        // Restore form fields
        var f = draft.fields;
        document.getElementById('advertiser-name').value = f.advertiserName || '';
        document.getElementById('acct-number').value = f.acctNumber || '';
        document.getElementById('contact-name').value = f.contactName || '';
        document.getElementById('contact-email').value = f.contactEmail || '';
        document.getElementById('billing-address').value = f.billingAddress || '';
        document.getElementById('new-customer').checked = f.newCustomer || false;
        document.getElementById('billing-group').style.display = f.newCustomer ? 'block' : 'none';
        document.getElementById('package-type').value = f.packageType || 'custom';
        document.getElementById('default-size').value = f.defaultSize || 'full';
        document.getElementById('start-volume').value = f.startVolume || '32';
        document.getElementById('start-issue').value = f.startIssue || '0';
        document.getElementById('customize-sizes').checked = f.customizeSizes || false;
        document.getElementById('web-banner').checked = f.webBanner || false;
        if (f.webBanner) document.getElementById('banner-card').classList.add('selected');
        document.getElementById('email-ads').checked = f.emailAds || false;
        if (f.emailAds) {
            document.getElementById('email-card').classList.add('selected');
            document.getElementById('email-qty-row').style.display = 'flex';
        }
        document.getElementById('email-in-season').value = f.emailInSeason || '0';
        document.getElementById('email-off-season').value = f.emailOffSeason || '0';
        document.getElementById('banner-price-input').value = f.bannerPrice || '2600';
        document.getElementById('banner-start-date').value = f.bannerStartDate || '';
        document.getElementById('banner-end-date').value = f.bannerEndDate || '';
        document.getElementById('opt-design').checked = f.optDesign || false;
        document.getElementById('opt-ncaa').checked = f.optNcaa || false;
        document.getElementById('prepay-discount').checked = f.prepayDiscount || false;
        document.getElementById('notes').value = f.notes || '';
        document.getElementById('signed-by').value = f.signedBy || 'Bryan';
        document.getElementById('sign-date').value = f.signDate || new Date().toISOString().split('T')[0];

        // Restore discounts
        var container = document.getElementById('discounts-container');
        container.innerHTML = '';
        if (draft.discounts) {
            draft.discounts.forEach(function(d) {
                addDiscount();
                var rows = container.querySelectorAll('.discount-row');
                var lastRow = rows[rows.length - 1];
                lastRow.querySelector('input[type="text"]').value = d.desc || '';
                lastRow.querySelector('input[type="number"]').value = d.amt || '';
            });
        }

        // Rebuild accordion and sync
        buildVolumeSelector();
        syncStateToDOM();

        // Sync volume checkboxes and show checked volume sections
        syncStateToDOM();

        recalculate();
        attachAutoSave();
    } catch(e) {
        console.error('Draft restore error:', e);
        localStorage.removeItem(DRAFT_KEY);
        init();
    }
}

function clearDraftAndInit() {
    document.getElementById('draft-modal').classList.remove('visible');
    localStorage.removeItem(DRAFT_KEY);
    init();
}

// ============================================================
//  RESET
// ============================================================
function resetForm() {
    if (!confirm('Clear all form data?')) return;
    document.getElementById('io-form').reset();
    document.getElementById('discounts-container').innerHTML = '';
    STATE.selectedIssues = {};
    STATE.customizeSizes = false;
    STATE.expandedVolumes = { 32: true };
    STATE.bannerPrice = 2600;
    STATE.emailInSeason = 0;
    STATE.emailOffSeason = 0;
    document.getElementById('billing-group').style.display = 'none';
    document.getElementById('email-qty-row').style.display = 'none';
    document.getElementById('banner-card').classList.remove('selected');
    document.getElementById('email-card').classList.remove('selected');
    document.getElementById('signed-by').value = 'Bryan';
    document.getElementById('banner-price-input').value = '2600';
    localStorage.removeItem(DRAFT_KEY);
    buildVolumeSelector();
    setTodayDate();
    detectNextIssue();
    recalculate();
}

// ============================================================
//  LOGIN
// ============================================================
function checkPassword() {
    var pw = document.getElementById('login-password').value;
    if (pw === 'pin2win3') {
        document.getElementById('login-overlay').classList.add('hidden');
        document.getElementById('main-content').classList.add('visible');
        if (hasDraft()) {
            var advName = getDraftAdvertiserName();
            document.getElementById('draft-modal-text').textContent = 'Continue draft for "' + advName + '"?';
            document.getElementById('draft-modal').classList.add('visible');
        } else {
            init();
        }
    } else {
        document.getElementById('login-error').style.display = 'block';
        document.getElementById('login-password').value = '';
        document.getElementById('login-password').focus();
    }
}
</script>
</body>
</html>